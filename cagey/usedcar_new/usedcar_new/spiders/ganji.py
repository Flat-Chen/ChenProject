# -*- coding: utf-8 -*-
import scrapy
import re
import time
from usedcar_new.items import GanjiItem


class GanjiSpider(scrapy.Spider):
    name = 'ganji'
    allowed_domains = ['ganji.com']
    # start_urls = ['http://ganji.com/']

    @classmethod
    def update_settings(cls, settings):
        settings.setdict(
            getattr(cls, 'custom_debug_settings' if getattr(cls, 'is_debug', False) else 'custom_settings', None) or {},
            priority='spider')

    is_debug = True
    custom_debug_settings = {
        # 'MYSQLDB_SERVER': '127.0.0.1',
        # 'MYSQLDB_PASS': 'yangkaiqi',
        'MYSQL_TABLE': 'ganji_online',
        'MYSQL_DB': 'usedcar_update',
        'CrawlCar_Num': 1000000,
        'CONCURRENT_REQUESTS': 16,
        'DOWNLOAD_DELAY': 0,
        'RANDOMIZE_DOWNLOAD_DELAY': True,
        'DOWNLOADER_MIDDLEWARES': {
           # 'usedcar_new.middlewares.SeleniumIPMiddleware': 600,
           'usedcar_new.middlewares.ProxyMiddleware': 700,
           'scrapy.downloadermiddlewares.retry.RetryMiddleware': 800,
            },
        'ITEM_PIPELINES': {
            'usedcar_new.pipelines.GanjiPipeline': 300,
            },
    }

    def __init__(self, **kwargs):
        super(GanjiSpider, self).__init__(**kwargs)
        # self.r = redis.Redis(host=setting["REDIS_HOST"], db=setting["REDIS_DB"])
        # self.cookie = self.r.get('chezhibao_cookie').decode('utf8')
        # self.r.close()
        self.city_list = ['http://anshan.ganji.com/', 'http://anyang.ganji.com/', 'http://anqing.ganji.com/', 'http://ankang.ganji.com/', 'http://akesu.ganji.com/', 'http://anshun.ganji.com/', 'http://aletai.ganji.com/', 'http://alashan.ganji.com/', 'http://aba.ganji.com/', 'http://ali.ganji.com/', 'http://alaer.ganji.com/', 'http://aomen.ganji.com/', 'http://bj.ganji.com/', 'http://baoding.ganji.com/', 'http://binzhou.ganji.com/', 'http://baotou.ganji.com/', 'http://baoji.ganji.com/', 'http://benxi.ganji.com/', 'http://bengbu.ganji.com/', 'http://beihai.ganji.com/', 'http://bayannaoer.ganji.com/', 'http://baicheng.ganji.com/', 'http://baishan.ganji.com/', 'http://bozhou.ganji.com/', 'http://bazhong.ganji.com/', 'http://baiyin.ganji.com/', 'http://baise.ganji.com/', 'http://bijie.ganji.com/', 'http://bayinguoleng.ganji.com/', 'http://baoshan.ganji.com/', 'http://boertala.ganji.com/', 'http://cd.ganji.com/', 'http://cq.ganji.com/', 'http://cs.ganji.com/', 'http://cc.ganji.com/', 'http://changzhou.ganji.com/', 'http://cangzhou.ganji.com/', 'http://chifeng.ganji.com/', 'http://chengde.ganji.com/', 'http://changde.ganji.com/', 'http://changzhi.ganji.com/', 'http://chenzhou.ganji.com/', 'http://chuzhou.ganji.com/', 'http://chaohu.ganji.com/', 'http://chaozhou.ganji.com/', 'http://changji.ganji.com/', 'http://chizhou.ganji.com/', 'http://chuxiong.ganji.com/', 'http://chongzuo.ganji.com/', 'http://changdu.ganji.com/', 'http://chaoyang.ganji.com/', 'http://changshu.ganji.com/', 'http://cixi.ganji.com/', 'http://dl.ganji.com/', 'http://dg.ganji.com/', 'http://dezhou.ganji.com/', 'http://dongying.ganji.com/', 'http://daqing.ganji.com/', 'http://datong.ganji.com/', 'http://dandong.ganji.com/', 'http://danzhou.ganji.com/', 'http://deyang.ganji.com/', 'http://dazhou.ganji.com/', 'http://dali.ganji.com/', 'http://daxinganling.ganji.com/', 'http://dingxi.ganji.com/', 'http://dehong.ganji.com/', 'http://diqing.ganji.com/', 'http://diaoyudao.ganji.com/', 'http://eerduosi.ganji.com/', 'http://enshi.ganji.com/', 'http://ezhou.ganji.com/', 'http://fz.ganji.com/', 'http://foshan.ganji.com/', 'http://fushun.ganji.com/', 'http://fuyang.ganji.com/', 'http://fuxin.ganji.com/', 'http://jxfuzhou.ganji.com/', 'http://fangchenggang.ganji.com/', 'http://gz.ganji.com/', 'http://gy.ganji.com/', 'http://gl.ganji.com/', 'http://ganzhou.ganji.com/', 'http://guangyuan.ganji.com/', 'http://guangan.ganji.com/', 'http://guigang.ganji.com/', 'http://guyuan.ganji.com/', 'http://gannan.ganji.com/', 'http://ganzi.ganji.com/', 'http://guoluo.ganji.com/', 'http://hz.ganji.com/', 'http://huizhou.ganji.com/', 'http://hrb.ganji.com/', 'http://hf.ganji.com/', 'http://nmg.ganji.com/', 'http://hn.ganji.com/', 'http://handan.ganji.com/', 'http://heze.ganji.com/', 'http://hengshui.ganji.com/', 'http://huaian.ganji.com/', 'http://hengyang.ganji.com/', 'http://huludao.ganji.com/', 'http://huainan.ganji.com/', 'http://hanzhong.ganji.com/', 'http://huaihua.ganji.com/', 'http://huaibei.ganji.com/', 'http://huanggang.ganji.com/', 'http://huzhou.ganji.com/', 'http://huangshi.ganji.com/', 'http://hulunbeier.ganji.com/', 'http://heyuan.ganji.com/', 'http://hebi.ganji.com/', 'http://hegang.ganji.com/', 'http://huangshan.ganji.com/', 'http://honghe.ganji.com/', 'http://hechi.ganji.com/', 'http://hami.ganji.com/', 'http://heihe.ganji.com/', 'http://hezhou.ganji.com/', 'http://haixi.ganji.com/', 'http://hetian.ganji.com/', 'http://haibei.ganji.com/', 'http://haidong.ganji.com/', 'http://huangnan.ganji.com/', 'http://jn.ganji.com/', 'http://jining.ganji.com/', 'http://jilin.ganji.com/', 'http://jinzhou.ganji.com/', 'http://jinhua.ganji.com/', 'http://jiaxing.ganji.com/', 'http://jiangmen.ganji.com/', 'http://jingzhou.ganji.com/', 'http://jiaozuo.ganji.com/', 'http://jinzhong.ganji.com/', 'http://jiamusi.ganji.com/', 'http://jiujiang.ganji.com/', 'http://jincheng.ganji.com/', 'http://jingmen.ganji.com/', 'http://jixi.ganji.com/', 'http://jian.ganji.com/', 'http://jieyang.ganji.com/', 'http://jingdezhen.ganji.com/', 'http://jiyuan.ganji.com/', 'http://jiuquan.ganji.com/', 'http://jinchang.ganji.com/', 'http://jiayuguan.ganji.com/', 'http://jiaozhou.ganji.com/', 'http://jimo.ganji.com/', 'http://km.ganji.com/', 'http://kaifeng.ganji.com/', 'http://kashi.ganji.com/', 'http://kelamayi.ganji.com/', 'http://kuerle.ganji.com/', 'http://kezilesu.ganji.com/', 'http://kunshan.ganji.com/', 'http://lz.ganji.com/', 'http://xz.ganji.com/', 'http://langfang.ganji.com/', 'http://linyi.ganji.com/', 'http://luoyang.ganji.com/', 'http://liaocheng.ganji.com/', 'http://liuzhou.ganji.com/', 'http://lianyungang.ganji.com/', 'http://linfen.ganji.com/', 'http://luohe.ganji.com/', 'http://liaoyang.ganji.com/', 'http://leshan.ganji.com/', 'http://luzhou.ganji.com/', 'http://luan.ganji.com/', 'http://loudi.ganji.com/', 'http://laiwu.ganji.com/', 'http://longyan.ganji.com/', 'http://lvliang.ganji.com/', 'http://lishui.ganji.com/', 'http://liangshan.ganji.com/', 'http://lijiang.ganji.com/', 'http://liupanshui.ganji.com/', 'http://liaoyuan.ganji.com/', 'http://laibin.ganji.com/', 'http://lincang.ganji.com/', 'http://longnan.ganji.com/', 'http://linxia.ganji.com/', 'http://linzhi.ganji.com/', 'http://mianyang.ganji.com/', 'http://mudanjiang.ganji.com/', 'http://maoming.ganji.com/', 'http://meizhou.ganji.com/', 'http://maanshan.ganji.com/', 'http://meishan.ganji.com/', 'http://nj.ganji.com/', 'http://nb.ganji.com/', 'http://nn.ganji.com/', 'http://nc.ganji.com/', 'http://nantong.ganji.com/', 'http://nanyang.ganji.com/', 'http://nanchong.ganji.com/', 'http://neijiang.ganji.com/', 'http://nanping.ganji.com/', 'http://ningde.ganji.com/', 'http://nujiang.ganji.com/', 'http://naqu.ganji.com/', 'http://pingdingshan.ganji.com/', 'http://puyang.ganji.com/', 'http://panjin.ganji.com/', 'http://putian.ganji.com/', 'http://panzhihua.ganji.com/', 'http://pingxiang.ganji.com/', 'http://pingliang.ganji.com/', 'http://puer.ganji.com/', 'http://pixian.ganji.com/', 'http://qd.ganji.com/', 'http://qh.ganji.com/', 'http://qinhuangdao.ganji.com/', 'http://quanzhou.ganji.com/', 'http://qiqihaer.ganji.com/', 'http://qingyuan.ganji.com/', 'http://qujing.ganji.com/', 'http://quzhou.ganji.com/', 'http://qingyang.ganji.com/', 'http://qitaihe.ganji.com/', 'http://qinzhou.ganji.com/', 'http://qianjiang.ganji.com/', 'http://qiandongnan.ganji.com/', 'http://qiannan.ganji.com/', 'http://qianxinan.ganji.com/', 'http://rizhao.ganji.com/', 'http://rikaze.ganji.com/', 'http://sh.ganji.com/', 'http://sz.ganji.com/', 'http://sy.ganji.com/', 'http://sjz.ganji.com/', 'http://su.ganji.com/', 'http://shantou.ganji.com/', 'http://shangqiu.ganji.com/', 'http://sanya.ganji.com/', 'http://suqian.ganji.com/', 'http://shaoxing.ganji.com/', 'http://shiyan.ganji.com/', 'http://siping.ganji.com/', 'http://sanmenxia.ganji.com/', 'http://shaoyang.ganji.com/', 'http://shangrao.ganji.com/', 'http://suining.ganji.com/', 'http://sanming.ganji.com/', 'http://suihua.ganji.com/', 'http://shihezi.ganji.com/', 'http://ahsuzhou.ganji.com/', 'http://shaoguan.ganji.com/', 'http://songyuan.ganji.com/', 'http://suizhou.ganji.com/', 'http://shanwei.ganji.com/', 'http://shuangyashan.ganji.com/', 'http://shuozhou.ganji.com/', 'http://shizuishan.ganji.com/', 'http://shangluo.ganji.com/', 'http://shennongjia.ganji.com/', 'http://shannan.ganji.com/', 'http://shuangliu.ganji.com/', 'http://tj.ganji.com/', 'http://ty.ganji.com/', 'http://tangshan.ganji.com/', 'http://taian.ganji.com/', 'http://zjtaizhou.ganji.com/', 'http://jstaizhou.ganji.com/', 'http://tieling.ganji.com/', 'http://tongliao.ganji.com/', 'http://tonghua.ganji.com/', 'http://tianshui.ganji.com/', 'http://tongling.ganji.com/', 'http://tongchuan.ganji.com/', 'http://tongren.ganji.com/', 'http://tianmen.ganji.com/', 'http://tacheng.ganji.com/', 'http://tulufan.ganji.com/', 'http://tumushuke.ganji.com/', 'http://wh.ganji.com/', 'http://wx.ganji.com/', 'http://xj.ganji.com/', 'http://wei.ganji.com/', 'http://weifang.ganji.com/', 'http://wenzhou.ganji.com/', 'http://wuhu.ganji.com/', 'http://weinan.ganji.com/', 'http://wuhai.ganji.com/', 'http://wuzhou.ganji.com/', 'http://wulanchabu.ganji.com/', 'http://wuwei.ganji.com/', 'http://wenshan.ganji.com/', 'http://wuzhong.ganji.com/', 'http://wujiaqu.ganji.com/', 'http://wuzhishan.ganji.com/', 'http://xa.ganji.com/', 'http://xm.ganji.com/', 'http://xn.ganji.com/', 'http://xuzhou.ganji.com/', 'http://xianyang.ganji.com/', 'http://xingtai.ganji.com/', 'http://xiangyang.ganji.com/', 'http://xinxiang.ganji.com/', 'http://xiangtan.ganji.com/', 'http://xuchang.ganji.com/', 'http://xinyang.ganji.com/', 'http://xiaogan.ganji.com/', 'http://xinzhou.ganji.com/', 'http://xianning.ganji.com/', 'http://xinyu.ganji.com/', 'http://xuancheng.ganji.com/', 'http://xiantao.ganji.com/', 'http://xilinguole.ganji.com/', 'http://xiangxi.ganji.com/', 'http://xingan.ganji.com/', 'http://xishuangbanna.ganji.com/', 'http://xianggang.ganji.com/', 'http://yc.ganji.com/', 'http://yichang.ganji.com/', 'http://yantai.ganji.com/', 'http://yangzhou.ganji.com/', 'http://yancheng.ganji.com/', 'http://yingkou.ganji.com/', 'http://yueyang.ganji.com/', 'http://yuncheng.ganji.com/', 'http://sxyulin.ganji.com/', 'http://yibin.ganji.com/', 'http://yangquan.ganji.com/', 'http://yanan.ganji.com/', 'http://yiyang.ganji.com/', 'http://yongzhou.ganji.com/', 'http://gxyulin.ganji.com/', 'http://jxyichun.ganji.com/', 'http://yangjiang.ganji.com/', 'http://yanbian.ganji.com/', 'http://yuxi.ganji.com/', 'http://yili.ganji.com/', 'http://yunfu.ganji.com/', 'http://hljyichun.ganji.com/', 'http://yaan.ganji.com/', 'http://yingtan.ganji.com/', 'http://yushu.ganji.com/', 'http://yiwu.ganji.com/', 'http://zz.ganji.com/', 'http://zhuhai.ganji.com/', 'http://zibo.ganji.com/', 'http://zhongshan.ganji.com/', 'http://zaozhuang.ganji.com/', 'http://zhangjiakou.ganji.com/', 'http://zhuzhou.ganji.com/', 'http://zhenjiang.ganji.com/', 'http://zhoukou.ganji.com/', 'http://zhanjiang.ganji.com/', 'http://zhumadian.ganji.com/', 'http://zhaoqing.ganji.com/', 'http://zigong.ganji.com/', 'http://zunyi.ganji.com/', 'http://zhangzhou.ganji.com/', 'http://zhoushan.ganji.com/', 'http://zhangye.ganji.com/', 'http://ziyang.ganji.com/', 'http://zhangjiajie.ganji.com/', 'http://zhaotong.ganji.com/', 'http://zhongwei.ganji.com/']
        # self.series_list = ['cadillac-diwei', 'changhe', 'audi-a6l', 'jieluchi', 'benz-mb', 'benz-c', 'benz-e', 'lamborghini', 'maiteng', 'kunchengpika', 'landekuluze', 'oulande', 'bentley-oulu', 'lufengfenghua', 'smart', 'haima-aishang', 'wuxian-v7', 'audi-s4', 'hongqi', 'wu', 'volvo-960', 'huaguan', 'ford-yema', 'benteng', 'changcheng-hafum1', 'youya', 'huandong', 'lingmu-jimuni', 'biaozhi-4007', 'c5-jinkou', 'fute-ruijie', 'benteng-b70', 'skoda', 'lifan520i', 'bentley', 'huiteng', 'chipeng', 'b11', 'changcheng-jingling', 'rongweiw5', 'huachen-zhonghua', 'luhu-lanshengjiguang', 'qienuoji', 'subaru', 'yusheng007', 'volvo-c30', 'kubao', 'perla', 'hafei', 'richan-370z', 'jilindafa', 'aoxuang5', 'lexus-ls', 'richan-armada', 'xufulan-sipake', 'v3-lingyue', 'volvo-s90', 'taiyangwu', 'dongnan', 'mitsubishi-v73', 'toyota-mr2', 'lingshen', 'grancabrio', 'byd-f3-r', 'audi-a7', 'richan-cube', 'changling-pika', 'changan-zhixiang', 'lifan520', 'shangku', 'jlshwuche', 'kia-sephia', 'jinbei-badao', 'benz-clk', 'changhe-junma', 'changan-yuexiang-v5', 'audi-a4l', 'zhengzhouhaimawangzi', 'landrover-shenxingzhe2', 'tule', 'volvo-s70', 'yinglangxt', 'nv200', 'xiyenei', 'wuxian-v5', 'mingshi', 'suolantuo', 'qiya-picanto', 'suzuki-splash', 'jiao-shuaichi', 'buick-gl8', 'hafei-junyi', 'changcheng', 'byd-g3r', 'buick-encore', 'fengjing', 'opel', 'toyota-corona', 'dongfangzhizi-cross', 'yakeshi', 'xiali-n5', 'ruilin-g5', 'zhongtai', 'byd', 'xinyatu-younike', 'yueyue', 'toyota-haishi', 'tongyue-rs', 'oujieli', 'audi-q7', 'kailing', 'alfaromeo-156', 'biaozhi-307sw', 'murcielago', 'hyundai-tucson', 'tuoluzhe', 'fengshena60', 'ford-c-max', 'jiebao-xk', 'qichen-d50', 'audi', 'hyundai-ruina', 'saina', 'h230', 'jiebao-s-type', 'qirui-qq3', 'lufeng-x9', 'acura-tl', 'jingcheng', 'biaozhi-207cc', 'rongwei750', 'jiaodoushi', 'lexus-rx', 'citroen', 'baojun', 'biaozhi', 'licheng', 'ford-ka', 'xinyatu', 'audi-s8', 'benz-sprinter', 'mitsubishi-grunder', 'cts-coupe', 'jingling-cross', 'honda', 'qiling', 'audi-s3', 'changan-yuexiang-v3', 'jiao', 'hyundai-laoensikupai', 'jiaochahuoli', 'xiaoguizu', 'volvo-850', 'ruiying', 'd22pika', 'wuling', 'langdi', 'leichi', 'fulika', 'toyota-verso', 'jeep', 'hanma-h3', 'xingfeidu', 'zhongxing', 'huanghai-xinqisheng-cuv', 'ford-taurus', 'yuanjian', 'saab9-5', 'feiteng', 'jiabao', 'bolaqi', 'falali-ff', '308cc', 'hongtu', 'feidie-ufo', 'beiqi', 'dazhong', 'baolai', 'cf-yangzi', 'weilin-x5', 'porsche-boxster', 'ford-fusion', 'sidi', 'saima', 'chrysler-pacifica', 'pagani-zonda', 'lexus-is', 'telaka', 'kuxiong', 'changanlingmu-shangyue', 'maserati-coupe', 'aidier', 'ruilin-x1', 'lifanx60', 'dongfengfengshen', 'lotuscars', 'byd-m6', 'yuyan', 'skoda-superb', 'maybach-landaulet', 'shuaijian', 'qiyun', 'buick-junwei', 'dazhong-gaoer', 'cadillac-cts', 'tianlai', 'xuefulan-wolanda', 'hyundai-centennial', 'junjie-frv', 'xiwang', 'santana', 'qirui-qq6', 'nazhijie-ceo', 'xiaochaoren', 'rongwei350', 'huachen', 'kaimeirui', 'caihong', 'youyi', 'sailingpika', 'pnxiliehuoche', 'kaluola', 'audi-q5-jinkou', 'bmw-x3', 'changcheng-lingao', 'bmw-z8', 'toyota-4runner', 'baodian', 'jiebao', 'volvo-v40', 'datong-v80', 'changan-jiexun', 'galue-orochi', 'miniclubman', 'tj-yiqi', 'jinbei-dushijingling', 'citroen-c-crosser', 'buick-kaiyue', 'fengshenh30cross', 'fiat-fiorino-qubo', 'maserati', 'ferrari-enzo', 'kia-jiale', 'baojun630', 'infiniti', 'acura-tsx', 'xfl-express', 'lufeng', 'qirui-a1', 'lingli', 'astonmartin', 'yalishi', 'zhongyi', 'richan-kaipusida', 'hanma-h1', 'dazhong-tuan-haiwai', 'shijue-c8', 'lotus-rcr-jingyue', 'cadillac-sls-saiwei', 'yilante-yuedong', 'richan-yangguang', 'jianghuai-tongyue', 'huatai', 'lufengxinshijie', 'maserati-spyder', 'jingrui', 'xuanyi', 'byd-f6', 'qirui-fengyun', 'toyota-aygo', 'hanma-h2', 'heyuers', 'lexus-lx', 'mazda-rx-8', 'hyundai-i20', 'fudi-tansuozhe6', 'dadi', 'lotus-rcr-jingsu', 'minicountryman', 'bmw-7', 'changan-cx20', 'xiyate', 'linea', 'citroen-c4', 'chery', 'fengjun3', 'hyundai-coupe', 'byd-g6', 'biaozhi-807', 'furuida', 'haorui', 'changan', 'cadillac', 'benz-cls', 'benz-sl', 'spark-lechi', 'kaituezhe', 'yema-f10', 'kenisaige-ccxr', 'jumjiefsv', 'lufengx8', 'chery-qiyun5', 'junjie', 'asxjinxuan', 'luling', 'huaxiangfuqi', 'bmw-x5', 'lufengfengshang', 'dongfenyufeng', 'kia-rio', 'acura-ilx', 'grandepunto', 'jianghuai', 'byd-l3', 'dongfeng-mengshi', 'weilakesi', 'chuanqiyema', 'jeep-2500', 'jiebao-xj', 'volvo-xc70', 'honda-odyssey', 'buick-rongyu', 'fudi-tansuozhe2', 'meiganna', 'xima', 'acura-mdx', 'huanghai', 'kia', 'chrysler-300s', 'volvo', 'lufeng-x6', 'biaozhi-307-cross', 'palading', 'linken-mkz', 'rolls-royce', 'haima3', 'barui', 'dazhong-cc', 'jiebao-xf', 'biaozhi-406', 'buick-enclave', 'oulang-oulang', 'lingshuai', 'nanqi', 'dongfangzhizi', 'ruilin-g3', 'smart-fortwo', 'feiyang-pika', 'lexus-hs', 'beidouxing', 'benz-ml', 'rcz', 'byd-qin', 'lincoln-mks', 'turui', 'yousheng2', 'lingmu-weitela', 'buick-kaiyuehrv', 'byd-f3', 'volvo-s80', 'bq-yongshi', 'ferrari', 'lishi', 'jumjiecross', 'qqme', 'richan-gt-r', 'xiali-2000', 'laguna', 'ziyouren', 'lexus-gs', 'wulingzhiguang', 'feiyate500', 'junge', 'astonmartin-one-77', 'bujiadiweihang', 'gusite', 'yema-f99', 'kia-sportage', 'audi-100', 'dazhong-sharan', 'huanghai-aojun', 'focus-s-max', 'zhonghua-h530', 'biaozhi-307cc', 'zhinanzhe', 'ferrari-f430', 'chrysler-300c', 'pajieluosupao', 'biaozhi-508-jinkou', 'puladuo-jinkou', 'guishi', 'mini-mini', 'xingwang', 'kaixuan', 'fengshens30', 'kuwei', 'dazhong-polo', 'fudi-tansuozhe3', 'lifan720', 'futian-aoling', 'sibalu-xv', 'lexus-ct', 'benz-slk', 'astonmartin-cygnet', 'chevrolet-keluzi', 'dongfeng-xiaowangzi', 'nazhijieda7suv', 'loulan', 'benz-b', 'dongnan-lingdong', 'daqienuoji', 'changan-yidong', 'jiayu', 'beidouxing-eplus', 'biaozhi-308', 'yida', 'buick', 'ruihu-3', 'fiat', 'audi-rs6', 'fang5', 'huanghai-xiaochaishen', 'volvo-s60', 'landrover', 'acura', 'rongwei550', 'escalade', 'liwei', 'krui', 'xuanfeng', 'shuanglong', 'kexijia', 'z300', 'ruilin-m5', 'toyota-avalon', 'zhongtai-5008', 'qishi', '458italia', 'zhongtai-z200hb', 'haima', 'zhonghua-v5', 'saab-9000cd', 'bmw-z4', 'chery-ruihudr', 'yinglunqiche', 'tuguan', 'ferrari-599-gto', 'rongguang', 'shiyun', 'minicabrio', 'byd-f0', 'dongfengyulongnazhijie', 'biaozhi-206cc', 'huatai-shengdafeic9', 'jeep-2700', 'audi-s6', 'youpai', 'jiebaox-type', 'maybach', 'toyota-tacoma', 'dushijunma-suv', 'laiwang', 'california', 'ferrari-f12berlinetta', 'mushang', 'fiat-sedici', 'haima-fushida', 'rongwei-g2', 'changfeng-leibao-ct5', 'wuling-yangguang', 'dongfeng', 'qiya-kaizun', 'toyota-puruisi', 'qichen', 'keleiao', 'audi-s7', 'chuanqi-x', 'wuxian', 'porsche-cayman', 'saiying', 'aohu', 'benz-a', 'jinbei-haixing', 'volvo-v70', 'hanlanda', 'richan-aodima', 'citroen-c3', 'saijun', 'alfaromeo', 'sailatu-oufeng', 'hafei-lubao', 'gelan', 'weihu', 'honda-s2000', 'brand-xiali', 'mini', 'biaozhi-206', 'lamborghini-reventon', 'mazda-ruiyi', 'midi', 'benbenlove', 'shuanghuan', 'datong', 'huanghai-aolong', 'borui', 'renault-talisiman', 'maserati-3200gt', 'astonmartin-virage', 'pajieluo', 'qida', 'yasen', 'richan-xiaoke', 'benz-slr', 'byd-f3dm', 'hoverpai', 'volvo-xc60', 'zunchi', 'richan-fuga', 'weizi', 'porsche', 'changan-cs35', 'leilong', 'junjie-wagon', 'lexus-lf-a', 'hyundai-trajet', 'jinbei-kuaiyun', 'ferrari612-scaglietti', 'audi-200', 'benz-newr', 'futian', 'gongyang', 'yihu', 'haifuxing', 'linians1', 'sailatu', 'i-yage', 'xiandai-ix35', 'audi-a4', 'fengdu', 'huiyi', 'audi-a8l', 'aierfa', 'ford-thunderbird', 'senlinren', 'ford', 'mazda3-mx-5', 'jeep-ziyouke', 'boyue', 'bmw-8', 'zhihuiguan', 'benz-cl', 'acura-rdx', 'biaozhi-505', 'saab', 'cadillac-wude', 'byd-e6', 'lexus', 'weida', 'siborui', 'jinbei-zhishang-s30', 'oulang', 'honda-cr-z', 'cadillac-esv', 'ghibli', 'v10', 'outlander-ex', 'astonmartin-dbs', 'mazda', 'hyundai-langdong', 'mazda5', 'acura-rsx', 'yongyuanqiche', 'toyota-markx', 'skoda-yeti', 'subaru-brz', 'ford-tempo', 'meijia', 'suteng', 'minicoupe', 'ruihu', 'jinbeis50', 'futian-mengpaike', 'citroen-c1', 'z200', 'yousheng', 'fulaikesi', 'suzuki-liyana', 'benteng-b50', 'mumaren', 'yiqitongyong', 'weilin-v5', 'xuefulan-kepaqi', 'benben', 'fengzhe', 'byd-s8', 'byd-s6', 'bentley-yazhi', 'andela', 'changcheng-fengjun5', 'yuansu', 'honda-elysion', 'jiao-gx5', 'kenisaige-agera', 'richan-pathfinder', 'dazhong-eos', 'kubo', 'haitun', 'actyon', 'youyou', 'jiangnantt', 'jiamei', 'weidu', 'dongfengqiya-k5', 'puruiweiya', 'jiebao-f-type', 'siyu', 'mazda8-outdoor', 'cadillac-cts-v', 'lingmu-kaizexi', 'bmw', 'chengshi', 'leisite', 'volvo-s80l', 'chrysler300m', 'toyota', 'fuqi6500', 'acura-rl', 'yashente', 'siming', 'buick-junyue', 'chery-v5', 'lincoln-mkt', 'saifeili', 'ruilin', 'weisaidi', 'fudi', 'volvo-v60', 'honda-insight', 'nj-iveco', 'astonmartin-db9', 'lexus-es', 'hyundai-i30', 'passat', 'ferrari-458', 'buick-linyindadao', 'weilin', 'kenisaige', 'mazda-tribute', 'fukang', 'ferrari599-gtb-fiorano', 'dongfengqiyafuruidi', 'luhu-lansheng', 'yema-f12', 'heijingang', 'ruilin-g6', 'panamera', 'lingyang', 'audi-a6', 'wulingxiaoxuanfeng', 'chevrolet-lechi', 'citroen-c2', 'kelanduo', 'fulaier', 'benz-gl', 'lifan620', 'linken-mkx', 'siming-s', 'changan-benbenmini', 'jiao-kaixuan', 'weile', 'shijia', 'biaozhi-307-liangxiang', 'cadillac-xlr', 'jetta', 'jindier', 'saifu', 'saibailing', 'jinbei-daohangzhe', 'galue-galue-convertible', 'linian', 'geshitu', 'bmw-1', 'volvo-s40-jinkou', 'bmw-z3', 'lexus-sc', 'mazda-cx-9', 'bmw-x1-jinkou', 'hyundai', 'renault', 'fengfan', 'toyota-sienna', 'haixiang', 'langyi', 'jiao-xingwang', 'jincheng', 'daoqi', 'miniroadster', 'sunata', 'shengdafei', 'kia-soul', 'toyota-tantu', 'smart-forfour', 'chery-qiyun2', 'shijue', 'jiangling', 'shunchipika', 'baowei', 'fengshenh30', 'toyota-wish', 'oumeijia', 'chery-qiyun3', 'ziyoufeng', 'aidier2', 'jiakechong', 'linken-ls', 'saikupika', 'yishen', 'feiyue', 'porsche-918', 'fiat-gubei', 'biaozhi-607', 'xuanli', 'chevrolet-mairuibao', 'laoensi', 'porsche-911', 'benz-g', 'tiguan', 'chevrolet-lumina', 'weizhiv2', 'fiat-croma', 'linghangyuan', 'fiat-viaggio', 'youjin', 'jinbei-geruisi3', 'yazun', 'binyue', 'cadillac-ats', 'suzuki', 'dongfengqiyazhipao', 'biaozhi-107', 'honda-pilot', 'jiao-kairui', 'haima-pulima', 'fute-fukesi', 'dazhong-fox', 'huanying', 'xuanli-cross', 'junyi', 'mitsubishi-lancer', 'benz', 'hyundai-i10', 'shijixing', 'jinbei-youyuezhe', 'audi-a5', 'palio', 'e5', 'biaozhi-4008', 'lotuscars-2-eleven', 'xingwangl', 'lanshengyundongban', 'lifan', 'infiniti-jx', 'changan-ruicheng', 'saab9-3', 'audi-rs5', 'futian-sapu', 'yikelisi', 'oufeilaisi', 'liebao', 'toyota-celica', 'sliver-spur', 'audi-a2', 'kia-ceed', 'hongshan', 'yuhu', 'galue-himiko', 'maserati-zongcai', 'richan-maxima', 'lanniao', 'mondeo', 'lifan320', 'lefeng', 'golf', 'audi-a3', 'toyota-fjkuluze', 'astonmartin-rapide', 'xiangyu', 'baolige', 'i-honda-crv', 'laferrari', 'aventador', 'biaozhi-2008', 'benz-s', 'bmw-3', 'yate', 'cadillac-ext', 'fiat-panda', 'aihu', 'haimaqiubite', 'xuefulan-kemailuo', 'biaozhi-408', 'mitsubishi', 'qirui-a5', 'qiya-k3', 'citroen-c6', 'pt-manbuzhe', 'audi-s5', 'feisi', 'biaozhi-407', 'wushiling', 'ludi', 'kia-carnival', 'rongwei', 'hyundai-xinsuonata', 'chery-qiyun1', 'aoxuang3', 'yusheng', 'galue', 'beijingxiandai-mingyu', 'changan-alto', 'pagani', 'shengshi', 'hanma', 'yongyuana380', 'hyundai-shengdafei', 'nazhijie-mpv', 'qibing', 'chevrolet', 'richan', 'fenglang', 'citroen-c8', 'kia-shuma', 'sh-huizhong', 'hongguang', 'audi-tts', 'dajiaoshou', 'chrysler', 'porsche-macan', 'cadillac-srx', 'lotus', 'bmw-x6', 'toyota-huangguan', 'buick-xinshiji', 'maybach-62', 'byd-g3', 'beijingqiche', 'bmw-5', 'm300', 'citroen-picasso', 'bujiadi', 'lincoln', 'haimaqishi', 'fuyun', 'mitsubishi-v77']
        self.brand_list = ['futian/', 'biaozhi/', 'fiat/', 'siming/', 'bentley/', 'nj-iveco/', 'bujiadi/', 'infiniti/', 'mini/', 'opel/', 'cadillac/', 'shuanglong/', 'landrover/', 'bmw/', 'oulang/', 'weilin/', 'zhongtai/', 'haima/', 'datong/', 'galue/', 'mazda/', 'beijingqiche/', 'alfaromeo/', 'buick/', 'honda/', 'wuling/', 'changhe/', 'dongnan/', 'hyundai/', 'lamborghini/', 'chevrolet/', 'renault/', 'pagani/', 'maybach/', 'lexus/', 'dongfengfengshen/', 'brand-xiali/', 'mitsubishi/', 'rongwei/', 'changan/', 'liebao/', 'nanqi/', 'volvo/', 'maserati/', 'hafei/', 'linian/', 'kia/', 'shuanghuan/', 'xiyate/', 'smart/', 'qichen/', 'huachen-zhonghua/', 'chrysler/', 'changcheng/', 'lufeng/', 'tj-yiqi/', 'dazhong/', 'hongqi/', 'lifan/', 'huachen/', 'jincheng/', 'jeep/', 'kenisaige/', 'benz/', 'chuanqiyema/', 'toyota/', 'krui/', 'huatai/', 'daoqi/', 'huanghai/', 'benteng/', 'huaxiangfuqi/', 'astonmartin/', 'jilindafa/', 'sh-huizhong/', 'saab/', 'suzuki/', 'subaru/', 'lincoln/', 'jiangling/', 'lotuscars/', 'wushiling/', 'cf-yangzi/', 'porsche/', 'yongyuanqiche/', 'fudi/', 'jiebao/', 'yiqitongyong/', 'dadi/', 'richan/', 'yinglunqiche/', 'dongfeng/', 'byd/', 'shijue/', 'zhongxing/', 'ruilin/', 'audi/', 'baojun/', 'beiqi/', 'jianghuai/', 'ford/', 'rolls-royce/', 'citroen/', 'acura/', 'lotus/', 'hanma/', 'skoda/', 'ferrari/', 'jlshwuche/', 'dongfengyulongnazhijie/', 'jiao/', 'chery/']
        self.counts = 0
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36',
            'Cookie': 'cityDomain=sh; lg=1; vehicle_list_view_type=1; ganji_uuid=2485121979228382957532; ganji_xuuid=72e76d3e-8065-424f-f72f-f7aa81882158.1574386312142; 58uuid=2246fe27-14b0-410b-b326-afbc92bda139; ErshoucheDetailPageScreenType=1680; gj_footprint=%5B%5B%22%5Cu4e8c%5Cu624b%5Cu623f%5Cu51fa%5Cu552e%22%2C%22http%3A%5C%2F%5C%2Fanshan.ganji.com%5C%2Ffang5%5C%2F%22%5D%5D; visited_tag_ids=%5B%2217306%22%2C%2217316%22%5D; als=0; GANJISESSID=1iakp6uu1h4leinjd4esn7h078; init_refer=; new_uv=5; Hm_lvt_8dba7bd668299d5dabbd8190f14e4d34=1574386311,1574651797,1574732117; _gl_tracker=%7B%22ca_source%22%3A%22-%22%2C%22ca_name%22%3A%22-%22%2C%22ca_kw%22%3A%22-%22%2C%22ca_id%22%3A%22-%22%2C%22ca_s%22%3A%22self%22%2C%22ca_n%22%3A%22-%22%2C%22ca_i%22%3A%22-%22%2C%22sid%22%3A34523215124%7D; new_session=0; citydomain=anshan; ershouche_visit2=%5B%7B%22m%22%3A%221199%22%7D%2C%7B%22m%22%3A%221307%22%2C%22p%22%3A%5B150000%2C200000%5D%7D%2C%7B%22m%22%3A%221307%22%2C%22p%22%3A%5B30000%2C50000%5D%7D%5D; __utmt=1; __utmt_~1=1; __utma=32156897.791742768.1574735014.1574735014.1574735014.1; __utmc=32156897; __utmz=32156897.1574735014.1.1.utmcsr=anshan.ganji.com|utmccn=(referral)|utmcmd=referral|utmcct=/chevrolet/p5/; __utmb=32156897.3.10.1574735014; xzfzqtoken=bPrw5cYjz5l7A69CXb9xIaZPQTrreC9s60b3IZPYQFItv%2BJ2L23mkbaLhQa%2FpLUGin35brBb%2F%2FeSODvMgkQULA%3D%3D; Hm_lpvt_8dba7bd668299d5dabbd8190f14e4d34=1574735035; ganji_login_act=1574735035361'
        }

    def start_requests(self):
        """
        全国只有40页数据
        地区列表页70页数据
        """
        for city in self.city_list:
            for brand in self.brand_list:
                list_url = city+brand
                # print(list_url)
                yield scrapy.Request(
                    url=list_url,
                    headers=self.headers,
                )

    def parse(self, response):
        car_list = response.xpath("//div[@class='layoutlist']/dl//div[@class='infor-titbox']/a/@href").getall()
        for car in car_list:
            print(car)
            time.sleep(1)
            yield scrapy.Request(
                url=car,
                callback=self.parse_detail,
                headers=self.headers,
                meta={
                    'dont_redirect': True,
                    'handle_httpstatus_list': [302]
                },
            )
        next_url = response.urljoin(response.xpath("//a[@class='next']/@href").get())
        yield scrapy.Request(
            url=next_url,
            callback=self.parse,
            headers=self.headers,
            meta={
                    'dont_redirect': True,
                    'handle_httpstatus_list': [302]
                },
        )


    def parse_detail(self, response):
        item = GanjiItem()
        # 忽略过期页面
        # if not response.xpath("//p[@class='error-tips1']/text()").get():
        #     print("页面不存在!")
        # else:
        print("*"*100)
        car_id_data = re.findall("com/(.*?)x.htm", response.url)
        item["carid"] = car_id_data[0].split("/")[1]
        try:
            item["shortdesc"] = response.xpath("//h1[@class='title-name']/text()").get().replace(" ", "").replace("\n", "")
        except :
            item["shortdesc"] = None
        item["price1"] = response.xpath("//i[@class='phoneNum-type']/text()").get()
        item["years"] = response.xpath("//li[@class='iNew-yeah']//i/text()").get()
        item["mileage"] = response.xpath("//li[@class='iNew-km']//i/text()").get()
        item["change_times"] = response.xpath("//li[@class='iNew-hu']//i/text()").get()
        item["car_source"] = 'ganji'
        item["grab_time"] = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
        item["parsetime"] = item["grab_time"]
        item["pagetitle"] = response.xpath("//title/text()").get()
        item["url"] = response.url
        item["brand"] = item["pagetitle"].replace("【", "").split(" ")[0] if item["pagetitle"] else None
        item["series"] = item["brand"]
        # try:
        #     item["series"] = item["pagetitle"].replace("【", "").split(" ")[1] if '款' and 'T' and '厢' not in item["pagetitle"].replace("【", "").split(" ")[1] else item["brand"]
        # except:
        #     item["series"] = None
        item["registeryear"] = response.xpath("//*[contains(text(),'上牌时间')]/../text()").get()
        item["color"] = response.xpath("//*[contains(text(),'车身颜色')]/../text()").get()
        item["body"] = response.xpath("//*[contains(text(),'车身结构')]/../text()").get()
        item["bodystyle"] = item["body"]
        item["emission"] = "".join(response.xpath("//*[contains(text(),'排放标准')]/../text()").getall()).replace(" ", "").replace("\n", "")
        item["gear"] = response.xpath("//*[contains(text(),'变速箱')]/../text()").get()
        item["output"] = response.xpath("//*[contains(text(),'排气量')]/../text()").get()
        item["usage"] = response.xpath("//*[contains(text(),'使用性质')]/../text()").get()
        item["insurance1_date"] = response.xpath("//*[contains(text(),'交强险到期')]/../text()").get()
        item["desc"] = "".join(response.xpath("//*[@class='det-detinfor']//p/text()").getall()).replace(" ", "").replace("\n", "").replace("\r", "")
        item["carddate"] = ",".join(response.xpath("//*[@class='stress-light']//text()").getall()).replace(" ", "").replace("\n", "")
        item["driverway"] = response.xpath("//p[contains(text(),'驱动方式')]/../following-sibling::li[1]/text()").get()
        item["fueltype"] = response.xpath("//p[contains(text(),'燃油种类')]/../following-sibling::li[1]/text()").get()
        item["seats"] = response.xpath("//p[contains(text(),'座位数')]/../following-sibling::li[1]/text()").get()
        item["city"] = response.xpath("//div[@class='crumbs clearfix']/a[1]/text()").get().replace("赶集", "")
        item["pagetime"] = response.xpath("//i[@class='f10 pr-5']/text()").get()
        item["guideprice"] = response.xpath("//span[@class='fc-org']/i/text()").get()
        item["statusplus"] = item["carid"]+'-'+item["price1"]
        # item[""] = response.xpath("").get()
        # item[""] = response.xpath("").get()
        # item[""] = response.xpath("").get()
        # print(item)
        yield item
